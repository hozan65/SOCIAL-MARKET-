<!-- SUPPORT AI CHAT WIDGET (paste before </body>) -->
<div id="aiSupportMount"></div>

<style>
  #aswBtn{
    position: fixed; right: 5px; bottom: 5px;
    width: 56px; height: 56px; border-radius: 999px;
    display:grid; place-items:center;
    font-size:22px; cursor:pointer; user-select:none;
    z-index:999999;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(0,0,0,.12);
    box-shadow: 0 10px 28px rgba(0,0,0,.18);
    backdrop-filter: blur(10px);
  }
  #aswBox{
    position: fixed; right: 5px; bottom: 70px;
    width: min(360px, calc(100vw - 10px));
    height: 520px;
    border-radius: 16px;
    background: rgba(255,255,255,.94);
    border: 1px solid rgba(0,0,0,.12);
    box-shadow: 0 18px 40px rgba(0,0,0,.22);
    backdrop-filter: blur(12px);
    z-index:999999;
    display:flex; flex-direction:column; overflow:hidden;
  }
  .aswHidden{ display:none; }
  .aswTop{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 12px 8px;
    border-bottom:1px solid rgba(0,0,0,.08);
  }
  .aswTitle{ font-weight:900; letter-spacing:.2px; }
  .aswClose{
    border:0; background:transparent; cursor:pointer;
    font-size:16px; opacity:.7;
  }
  .aswClose:hover{ opacity:1; }
  #aswMsgs{ flex:1; padding:12px; overflow:auto; }
  .aswMsg{
    max-width:85%;
    padding:10px 12px;
    border-radius:14px;
    margin:0 0 10px;
    line-height:1.25;
    font-size:14px;
    white-space:pre-wrap;
    word-wrap:break-word;
  }
  .aswMsg.user{
    margin-left:auto;
    background:rgba(0,0,0,.07);
    border:1px solid rgba(0,0,0,.08);
  }
  .aswMsg.ai{
    margin-right:auto;
    background:rgba(255,255,255,.9);
    border:1px solid rgba(0,0,0,.10);
  }
  .aswInputRow{
    display:flex; gap:8px;
    padding:10px 12px;
    border-top:1px solid rgba(0,0,0,.08);
  }
  #aswInput{
    flex:1;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.15);
    outline:none;
  }
  #aswSend{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.15);
    background:rgba(255,255,255,.9);
    font-weight:900;
    cursor:pointer;
  }
  #aswHint{
    padding:0 12px 12px;
    font-size:12px;
    opacity:.65;
  }
  @media (max-width:480px){
    #aswBox{ height:70vh; width:calc(100vw - 10px); }
  }
</style>

<script>
  (() => {
    if (window.__ASW_INIT__) return;
    window.__ASW_INIT__ = true;

    const API_URL = "/.netlify/functions/ai_support";

    function render() {
      if (document.getElementById("aswBtn")) return;

      const mount = document.getElementById("aiSupportMount") || document.body;

      mount.insertAdjacentHTML("beforeend", `
      <div id="aswBtn" role="button" aria-label="Open support chat" aria-expanded="false">ðŸ’¬</div>

      <div id="aswBox" class="aswHidden" aria-hidden="true">
        <div class="aswTop">
          <div class="aswTitle">Support</div>
          <button id="aswClose" class="aswClose" type="button" aria-label="Close">âœ•</button>
        </div>

        <div id="aswMsgs"></div>

        <div class="aswInputRow">
          <input id="aswInput" placeholder="Sorununu yaz..." autocomplete="off" />
          <button id="aswSend" type="button">Send</button>
        </div>

        <div id="aswHint">AI destek â€¢ aynÄ± dilde cevap</div>
      </div>
    `);

      const btn  = document.getElementById("aswBtn");
      const box  = document.getElementById("aswBox");
      const close= document.getElementById("aswClose");
      const msgs = document.getElementById("aswMsgs");
      const input= document.getElementById("aswInput");
      const send = document.getElementById("aswSend");

      const openBox = () => {
        box.classList.remove("aswHidden");
        box.setAttribute("aria-hidden","false");
        btn.setAttribute("aria-expanded","true");
        setTimeout(()=>input && input.focus(), 50);
      };
      const closeBox = () => {
        box.classList.add("aswHidden");
        box.setAttribute("aria-hidden","true");
        btn.setAttribute("aria-expanded","false");
      };

      btn.addEventListener("click", () => {
        box.classList.contains("aswHidden") ? openBox() : closeBox();
      });
      close.addEventListener("click", closeBox);

      const addMsg = (role, text) => {
        const div = document.createElement("div");
        div.className = "aswMsg " + role;
        div.textContent = text;
        msgs.appendChild(div);
        msgs.scrollTop = msgs.scrollHeight;
      };

      const sendMsg = async () => {
        const text = (input.value || "").trim();
        if (!text) return;

        addMsg("user", text);
        input.value = "";

        const typing = document.createElement("div");
        typing.className = "aswMsg ai";
        typing.textContent = "â€¦";
        msgs.appendChild(typing);
        msgs.scrollTop = msgs.scrollHeight;

        try {
          const r = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ message: text })
          });

          const data = await r.json().catch(() => ({}));
          typing.remove();

          if (!r.ok) return addMsg("ai", data.error || "Server error.");
          addMsg("ai", data.reply || "No reply.");
        } catch (e) {
          typing.remove();
          addMsg("ai", "Network error.");
        }
      };

      send.addEventListener("click", sendMsg);
      input.addEventListener("keydown", (e)=>{ if (e.key==="Enter") sendMsg(); });

      addMsg("ai", "Merhaba! YardÄ±m iÃ§in yazabilirsin. (English or TÃ¼rkÃ§e)");
    }

    document.addEventListener("DOMContentLoaded", render);
  })();
</script>
